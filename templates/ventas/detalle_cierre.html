{% extends 'base.html' %}

{% block title %}Detalle Cierre - MotoShop{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Cierre de Caja - {{ cierre.fecha|date:"d/m/Y" }} - Turno {{ cierre.get_turno_display }}</h1>
            <p class="page-subtitle">Realizado por {{ cierre.usuario.get_full_name }} - {{ cierre.fecha_cierre|date:"H:i" }}</p>
            
            {% if cierre.observaciones == "Cierre sin actividad" %}
                <div class="alert alert-info d-flex align-items-center mt-2" style="max-width: 600px;">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Este turno se cerró sin actividad comercial (sin ventas).</strong>
                </div>
            {% endif %}
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'exportar_cierre_pdf' cierre.id %}" class="btn btn-modern" style="background: #ef4444; color: white;">
                <i class="bi bi-file-pdf"></i> Exportar PDF
            </a>
            <a href="{% url 'lista_cierres' %}" class="btn btn-modern" style="background: #f3f4f6; color: #374151;">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Resumen del Cierre -->
    <div class="col-lg-8">
        <!-- Información General -->
        <div class="card mb-4">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Resumen del Cierre</h5>
            </div>
            <div class="card-body">
                {% if cierre.cantidad_ventas == 0 %}
                    <!-- Mensaje especial para cierres sin actividad -->
                    <div class="alert alert-secondary d-flex align-items-start mb-3">
                        <i class="bi bi-dash-circle me-2 mt-1" style="font-size: 24px;"></i>
                        <div>
                            <h6 class="mb-2"><strong>Turno sin Actividad</strong></h6>
                            <p class="mb-0">No se realizaron ventas durante este turno. Todos los montos están en $0.00</p>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="text-center p-3" style="background: #f9fafb; border-radius: 12px;">
                                <small class="text-muted d-block mb-1">Monto Inicial</small>
                                <h4 class="mb-0">$0.00</h4>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3" style="background: #f9fafb; border-radius: 12px;">
                                <small class="text-muted d-block mb-1">Total Ventas</small>
                                <h4 class="mb-0 text-muted">$0.00</h4>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3" style="background: #f9fafb; border-radius: 12px;">
                                <small class="text-muted d-block mb-1">Cantidad Ventas</small>
                                <h4 class="mb-0 text-muted">0</h4>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- Contenido normal cuando hay ventas -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="text-center p-3" style="background: #f9fafb; border-radius: 12px;">
                                <small class="text-muted d-block mb-1">Monto Inicial</small>
                                <h4 class="mb-0">${{ cierre.monto_inicial }}</h4>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3" style="background: #f9fafb; border-radius: 12px;">
                                <small class="text-muted d-block mb-1">Total Ventas</small>
                                <h4 class="mb-0 text-success">${{ cierre.total_ventas }}</h4>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3" style="background: #f9fafb; border-radius: 12px;">
                                <small class="text-muted d-block mb-1">Cantidad Ventas</small>
                                <h4 class="mb-0 text-primary">{{ cierre.cantidad_ventas }}</h4>
                            </div>
                        </div>
                    </div>

                    <!-- Desglose por Método de Pago -->
                    <h6 class="mb-3">Desglose por Método de Pago</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center p-3" style="border: 2px solid #10b981; border-radius: 12px;">
                                <div>
                                    <i class="bi bi-cash-coin" style="font-size: 24px; color: #10b981;"></i>
                                    <span class="ms-2">Efectivo</span>
                                </div>
                                <strong style="font-size: 18px;">${{ cierre.efectivo_ventas }}</strong>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center p-3" style="border: 2px solid #3b82f6; border-radius: 12px;">
                                <div>
                                    <i class="bi bi-credit-card" style="font-size: 24px; color: #3b82f6;"></i>
                                    <span class="ms-2">Débito</span>
                                </div>
                                <strong style="font-size: 18px;">${{ cierre.debito_ventas }}</strong>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center p-3" style="border: 2px solid #8b5cf6; border-radius: 12px;">
                                <div>
                                    <i class="bi bi-credit-card-2-front" style="font-size: 24px; color: #8b5cf6;"></i>
                                    <span class="ms-2">Crédito</span>
                                </div>
                                <strong style="font-size: 18px;">${{ cierre.credito_ventas }}</strong>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center p-3" style="border: 2px solid #f59e0b; border-radius: 12px;">
                                <div>
                                    <i class="bi bi-arrow-left-right" style="font-size: 24px; color: #f59e0b;"></i>
                                    <span class="ms-2">Transferencia</span>
                                </div>
                                <strong style="font-size: 18px;">${{ cierre.transferencia_ventas }}</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Egresos -->
                    {% if cierre.egresos > 0 %}
                    <div class="alert alert-warning">
                        <h6 class="mb-2"><i class="bi bi-exclamation-triangle"></i> Egresos del Turno</h6>
                        <div class="d-flex justify-content-between">
                            <span>Total de Egresos:</span>
                            <strong class="text-danger">${{ cierre.egresos }}</strong>
                        </div>
                        {% if cierre.detalle_egresos %}
                        <hr>
                        <small><strong>Detalle:</strong><br>{{ cierre.detalle_egresos }}</small>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endif %}

                <!-- Totales Finales (siempre se muestran) -->
                <div style="background: linear-gradient(135deg, #f9fafb, #ffffff); border-radius: 12px; padding: 20px; border: 2px solid #e5e7eb;">
                    <div class="d-flex justify-content-between mb-2 pb-2" style="border-bottom: 1px solid #e5e7eb;">
                        <span>Monto Final Esperado:</span>
                        <strong>${{ cierre.monto_final_esperado }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2 pb-2" style="border-bottom: 1px solid #e5e7eb;">
                        <span>Monto Final Real:</span>
                        <strong>${{ cierre.monto_final_real }}</strong>
                    </div>
                    <div class="d-flex justify-content-between" style="padding-top: 8px; border-top: 2px solid #1f2937;">
                        <strong>Diferencia:</strong>
                        <h4 class="mb-0 {% if cierre.diferencia >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if cierre.diferencia >= 0 %}+{% endif %}${{ cierre.diferencia }}
                        </h4>
                    </div>
                </div>

                {% if cierre.observaciones %}
                <div class="mt-3 p-3" style="background: #fef3c7; border-radius: 12px; border-left: 4px solid #f59e0b;">
                    <h6 class="mb-2"><i class="bi bi-chat-left-text"></i> Observaciones</h6>
                    <p class="mb-0">{{ cierre.observaciones }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Ventas del Turno -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-receipt"></i> Ventas del Turno ({{ ventas.count }})</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>CÓDIGO</th>
                                <th>HORA</th>
                                <th>CLIENTE</th>
                                <th>MÉTODO</th>
                                <th>TOTAL</th>
                                <th>ESTADO</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venta in ventas %}
                            <tr>
                                <td><span class="code-badge">#{{ venta.codigo_venta }}</span></td>
                                <td>{{ venta.fecha|date:"H:i" }}</td>
                                <td>
                                    {% if venta.cliente %}
                                        {{ venta.cliente.nombre_completo }}
                                    {% else %}
                                        <span class="text-muted">Consumidor Final</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="venta-metodo {{ venta.tipo_pago }}">
                                        {{ venta.get_tipo_pago_display }}
                                    </span>
                                </td>
                                <td><strong>${{ venta.total }}</strong></td>
                                <td>
                                    <span class="estado-venta {% if venta.estado_venta == 2 %}pagado{% elif venta.estado_venta == 1 %}pendiente{% else %}anulado{% endif %}">
                                        {{ venta.get_estado_venta_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    No hay ventas registradas en este turno
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Estadísticas -->
        <div class="card mb-4">
            <div class="card-header" style="background: #1f2937; color: white;">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Estadísticas</h5>
            </div>
            <div class="card-body">
                {% if cierre.cantidad_ventas > 0 %}
                    <div class="mb-3">
                        <small class="text-muted">Promedio por Venta</small>
                        <h4 class="mb-0">
                            ${% widthratio cierre.total_ventas cierre.cantidad_ventas 1 %}
                        </h4>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Método Más Usado</small>
                        <h5 class="mb-0">
                            {% if cierre.efectivo_ventas >= cierre.debito_ventas and cierre.efectivo_ventas >= cierre.credito_ventas and cierre.efectivo_ventas >= cierre.transferencia_ventas %}
                                Efectivo
                            {% elif cierre.debito_ventas >= cierre.efectivo_ventas and cierre.debito_ventas >= cierre.credito_ventas and cierre.debito_ventas >= cierre.transferencia_ventas %}
                                Débito
                            {% elif cierre.credito_ventas >= cierre.efectivo_ventas and cierre.credito_ventas >= cierre.debito_ventas and cierre.credito_ventas >= cierre.transferencia_ventas %}
                                Crédito
                            {% else %}
                                Transferencia
                            {% endif %}
                        </h5>
                    </div>
                {% else %}
                    <div class="alert alert-secondary mb-3">
                        <i class="bi bi-dash-circle"></i> Turno sin ventas
                    </div>
                {% endif %}
                
                <div>
                    <small class="text-muted">Estado del Cierre</small>
                    <h5 class="mb-0">
                        {% if cierre.diferencia == 0 %}
                            <span class="badge bg-success">Cuadrado</span>
                        {% elif cierre.diferencia > 0 %}
                            <span class="badge bg-warning">Sobrante</span>
                        {% else %}
                            <span class="badge bg-danger">Faltante</span>
                        {% endif %}
                    </h5>
                </div>
            </div>
        </div>

        <!-- Gráfico -->
        {% if cierre.cantidad_ventas > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Distribución</h5>
            </div>
            <div class="card-body">
                <canvas id="distribucionChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- Acciones -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Acciones</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'exportar_cierre_pdf' cierre.id %}" class="btn btn-modern" style="background: #ef4444; color: white;">
                        <i class="bi bi-file-pdf"></i> Descargar PDF
                    </a>
                    <button class="btn btn-modern" style="background: #3b82f6; color: white;" onclick="window.print()">
                        <i class="bi bi-printer"></i> Imprimir
                    </button>
                    <form method="post" action="{% url 'recalcular_cierre' cierre.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-modern w-100" style="background: #f59e0b; color: white;">
                            <i class="bi bi-arrow-clockwise"></i> Recalcular Totales
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Gráfico de distribución (solo si hay ventas)
{% if cierre.cantidad_ventas > 0 %}
const ctx = document.getElementById('distribucionChart');
if (ctx) {
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Efectivo', 'Débito', 'Crédito', 'Transferencia'],
            datasets: [{
                data: [
                    {{ cierre.efectivo_ventas }},
                    {{ cierre.debito_ventas }},
                    {{ cierre.credito_ventas }},
                    {{ cierre.transferencia_ventas }}
                ],
                backgroundColor: [
                    '#10b981',
                    '#3b82f6',
                    '#8b5cf6',
                    '#f59e0b'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': $' + context.parsed.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}
{% endif %}
</script>
{% endblock %}