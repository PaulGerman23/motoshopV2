{% extends 'base.html' %}

{% block title %}Historial de Cajas - MotoShop{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Historial de Cajas</h1>
            <p class="page-subtitle">Todas las cajas registradas en el sistema</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'caja_actual' %}" class="btn btn-modern" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                <i class="bi bi-cash-stack"></i> Caja Actual
            </a>
            <a href="{% url 'abrir_caja' %}" class="btn btn-primary-modern btn-modern">
                <i class="bi bi-plus-circle"></i> Abrir Nueva Caja
            </a>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Desde</label>
                <input type="date" name="fecha_desde" class="form-control" value="{{ request.GET.fecha_desde }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Hasta</label>
                <input type="date" name="fecha_hasta" class="form-control" value="{{ request.GET.fecha_hasta }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Usuario</label>
                <select name="usuario" class="form-select">
                    <option value="">Todos los usuarios</option>
                    {% for usuario in usuarios %}
                        <option value="{{ usuario.id }}" {% if request.GET.usuario == usuario.id|stringformat:"s" %}selected{% endif %}>
                            {{ usuario.get_full_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary-modern btn-modern flex-fill">
                    <i class="bi bi-search"></i> Buscar
                </button>
                <a href="{% url 'historial_cajas' %}" class="btn btn-modern" style="background: #f3f4f6; color: #374151;">
                    <i class="bi bi-x"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Cajas List -->
<div class="row g-4">
    {% for caja in cajas %}
    <div class="col-lg-6">
        <div class="card cierre-card">
            <div class="cierre-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="mb-1">
                            Caja #{{ caja.id }} 
                            {% if caja.estado == 'abierta' %}
                                <span class="badge bg-success ms-2">Abierta</span>
                            {% else %}
                                <span class="badge bg-secondary ms-2">Cerrada</span>
                            {% endif %}
                        </h5>
                        <p class="mb-0" style="opacity: 0.9;">
                            <i class="bi bi-person"></i> {{ caja.usuario.get_full_name }}
                        </p>
                    </div>
                    <div class="text-end">
                        <h4 class="mb-0">${{ caja.total_ventas }}</h4>
                        <small style="opacity: 0.9;">{{ caja.cantidad_ventas }} ventas</small>
                    </div>
                </div>
            </div>

            <div class="cierre-body">
                <!-- Fechas -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted small">Apertura:</span>
                        <strong>{{ caja.fecha_apertura|date:"d/m/Y H:i" }}</strong>
                    </div>
                    {% if caja.fecha_cierre %}
                    <div class="d-flex justify-content-between">
                        <span class="text-muted small">Cierre:</span>
                        <strong>{{ caja.fecha_cierre|date:"d/m/Y H:i" }}</strong>
                    </div>
                    {% endif %}
                </div>

                <!-- Métodos de Pago -->
                <div class="mb-3">
                    <h6 class="mb-2">Métodos de Pago</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="d-flex justify-content-between p-2" style="background: #f9fafb; border-radius: 8px;">
                                <span class="text-muted small">Efectivo:</span>
                                <strong>${{ caja.total_efectivo }}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between p-2" style="background: #f9fafb; border-radius: 8px;">
                                <span class="text-muted small">Débito:</span>
                                <strong>${{ caja.total_debito }}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between p-2" style="background: #f9fafb; border-radius: 8px;">
                                <span class="text-muted small">Crédito:</span>
                                <strong>${{ caja.total_credito }}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between p-2" style="background: #f9fafb; border-radius: 8px;">
                                <span class="text-muted small">Transferencia:</span>
                                <strong>${{ caja.total_transferencia }}</strong>
                            </div>
                        </div>
                    </div>
                </div>

                {% if caja.estado == 'cerrada' %}
                    <!-- Totales del Cierre -->
                    <div class="cierre-item">
                        <span class="cierre-label">Monto Inicial:</span>
                        <span class="cierre-value">${{ caja.monto_inicial }}</span>
                    </div>

                    <div class="cierre-item">
                        <span class="cierre-label">Egresos:</span>
                        <span class="cierre-value text-danger">-${{ caja.egresos }}</span>
                    </div>

                    <div class="cierre-item">
                        <span class="cierre-label">Esperado:</span>
                        <span class="cierre-value">${{ caja.monto_final_esperado }}</span>
                    </div>

                    <div class="cierre-item">
                        <span class="cierre-label">Real:</span>
                        <span class="cierre-value">${{ caja.monto_final_real }}</span>
                    </div>

                    <div class="cierre-item" style="border-top: 2px solid #e5e7eb; padding-top: 12px; margin-top: 12px;">
                        <span class="cierre-label">Diferencia:</span>
                        <span class="cierre-value {% if caja.diferencia >= 0 %}diferencia-positiva{% else %}diferencia-negativa{% endif %}">
                            {% if caja.diferencia >= 0 %}+{% endif %}${{ caja.diferencia }}
                        </span>
                    </div>
                {% else %}
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-unlock"></i> Esta caja está actualmente abierta
                    </div>
                {% endif %}

                <!-- Acciones -->
                <div class="d-flex gap-2 mt-3">
                    <a href="{% url 'detalle_caja' caja.id %}" class="btn btn-primary-modern btn-modern flex-fill">
                        <i class="bi bi-eye"></i> Ver Detalle
                    </a>
                    {% if caja.estado == 'cerrada' %}
                        <a href="{% url 'exportar_caja_pdf' caja.id %}" class="btn btn-modern" style="background: #ef4444; color: white;">
                            <i class="bi bi-file-pdf"></i> PDF
                        </a>
                    {% endif %}
                    <button class="btn btn-modern" style="background: #f3f4f6; color: #374151;" onclick="recalcularCaja({{ caja.id }})">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="empty-state">
                    <i class="bi bi-wallet2"></i>
                    <p>No hay cajas registradas</p>
                    <a href="{% url 'abrir_caja' %}" class="btn btn-primary-modern btn-modern mt-3">
                        <i class="bi bi-plus-circle"></i>
                        Abrir Primera Caja
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_css %}
<style>
.cierre-card {
    border: none;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
}

.cierre-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px;
}

.cierre-body {
    padding: 20px;
}

.cierre-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
}

.cierre-label {
    color: #6b7280;
}

.cierre-value {
    font-weight: 600;
    color: #1f2937;
}

.diferencia-positiva {
    color: #10b981 !important;
}

.diferencia-negativa {
    color: #ef4444 !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function recalcularCaja(cajaId) {
    if (confirm('¿Recalcular los totales de esta caja?')) {
        fetch(`/ventas/caja/${cajaId}/recalcular/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}