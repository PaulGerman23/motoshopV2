{% extends 'base.html' %}

{% block title %}Productos - MotoShop{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Gestión de Productos</h1>
            <p class="page-subtitle">Administra el inventario de repuestos</p>
        </div>
        <button class="btn btn-primary-modern btn-modern" data-bs-toggle="modal" data-bs-target="#modalProducto" onclick="abrirModalNuevo()">
            <i class="bi bi-plus-circle"></i>
            Nuevo Producto
        </button>
    </div>
</div>

<!-- Stats Summary -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="stat-card stat-card-purple">
            <div class="stat-icon">
                <i class="bi bi-box-seam"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ productos|length }}</div>
                <div class="stat-label">Total Productos</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card stat-card-green">
            <div class="stat-icon">
                <i class="bi bi-cash-coin"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">$152,350</div>
                <div class="stat-label">Valor Total del Stock</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card stat-card-orange">
            <div class="stat-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">4</div>
                <div class="stat-label">Productos con Stock Bajo</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card stat-card-blue">
            <div class="stat-icon">
                <i class="bi bi-tags"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">12</div>
                <div class="stat-label">Categorías</div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label small text-muted mb-1">Buscar Producto</label>
                <div class="search-box-modern">
                    <i class="bi bi-search"></i>
                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar por código o descripción...">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Categoría</label>
                <select class="form-select" id="filterCategoria">
                    <option value="">Todas las categorías</option>
                    {% for producto in productos %}
                        {% if producto.categoria %}
                            <option value="{{ producto.categoria.nombre }}">{{ producto.categoria.nombre }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Stock</label>
                <select class="form-select" id="filterStock">
                    <option value="">Todo el stock</option>
                    <option value="bajo">Stock bajo (< 10)</option>
                    <option value="medio">Stock medio (10-50)</option>
                    <option value="alto">Stock alto (> 50)</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-modern w-100" style="background: #f3f4f6; color: #374151;">
                    <i class="bi bi-arrow-clockwise"></i>
                    Limpiar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Products Table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="modern-table" id="tablaProductos">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" class="form-check-input">
                        </th>
                        <th>CÓDIGO</th>
                        <th>PRODUCTO</th>
                        <th>CATEGORÍA</th>
                        <th>PROVEEDOR</th>
                        <th>PRECIO COSTO</th>
                        <th>PRECIO VENTA</th>
                        <th>STOCK</th>
                        <th>MARGEN</th>
                        <th>ESTADO</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr class="producto-row" 
                        data-codigo="{{ producto.codigo }}"
                        data-descripcion="{{ producto.descripcion }}"
                        data-categoria="{{ producto.categoria.nombre|default:'' }}"
                        data-stock="{{ producto.stock }}">
                        <td>
                            <input type="checkbox" class="form-check-input">
                        </td>
                        <td>
                            <span class="code-badge">#{{ producto.codigo }}</span>
                        </td>
                        <td>
                            <div class="product-info">
                                <div class="product-avatar">
                                    <i class="bi bi-box-seam"></i>
                                </div>
                                <div>
                                    <div class="product-name">{{ producto.descripcion|truncatewords:10 }}</div>
                                    <small class="text-muted">SKU: {{ producto.codigo }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if producto.categoria %}
                                <span class="badge-modern" style="background: rgba(102, 126, 234, 0.1); color: #667eea;">
                                    {{ producto.categoria.nombre }}
                                </span>
                            {% else %}
                                <span class="badge-modern" style="background: #f3f4f6; color: #6b7280;">
                                    Sin categoría
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if producto.proveedor %}
                                <small>{{ producto.proveedor.razon_social|truncatewords:3 }}</small>
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="price-text">${{ producto.precio_costo }}</span>
                        </td>
                        <td>
                            <strong class="price-text-strong">${{ producto.precio_venta }}</strong>
                        </td>
                        <td>
                            {% if producto.stock <= producto.stock_minimo %}
                                <span class="stock-badge stock-low">
                                    <i class="bi bi-exclamation-circle"></i>
                                    {{ producto.stock }}
                                </span>
                            {% elif producto.stock <= producto.stock_minimo|add:"15" %}
                                <span class="stock-badge stock-medium">
                                    <i class="bi bi-dash-circle"></i>
                                    {{ producto.stock }}
                                </span>
                            {% else %}
                                <span class="stock-badge stock-high">
                                    <i class="bi bi-check-circle"></i>
                                    {{ producto.stock }}
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="margin-badge">
                                <i class="bi bi-graph-up-arrow"></i>
                                {{ producto.margen_ganancia|floatformat:1 }}%
                            </span>
                        </td>
                        <td>
                            {% if producto.estado == 1 %}
                                <span class="status-badge status-active">Activo</span>
                            {% else %}
                                <span class="status-badge status-inactive">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-action-view" data-bs-toggle="tooltip" title="Ver detalles" onclick="verDetalleProducto({{ producto.id }}, '{{ producto.codigo }}', '{{ producto.descripcion|escapejs }}', {{ producto.precio_costo }}, {{ producto.precio_venta }}, {{ producto.stock }}, '{{ producto.categoria.nombre|default:"Sin categoría" }}', '{{ producto.proveedor.razon_social|default:"Sin proveedor" }}', {{ producto.margen_ganancia|floatformat:1 }})">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn-action btn-action-edit" data-bs-toggle="modal" data-bs-target="#modalProducto" onclick="abrirModalEditar({{ producto.id }}, '{{ producto.codigo }}', '{{ producto.descripcion|escapejs }}', {{ producto.precio_costo }}, {{ producto.precio_venta }}, {{ producto.stock }}, '{{ producto.categoria.id|default:'' }}', '{{ producto.proveedor.id|default:'' }}', {{ producto.estado }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn-action btn-action-delete" onclick="confirmarEliminar({{ producto.id }}, '{{ producto.descripcion|escapejs }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="11" class="text-center py-5">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>No hay productos registrados</p>
                                <button class="btn btn-primary-modern btn-modern mt-3" data-bs-toggle="modal" data-bs-target="#modalProducto" onclick="abrirModalNuevo()">
                                    <i class="bi bi-plus-circle"></i>
                                    Crear Primer Producto
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Detalle Producto -->
<div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content modern-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title">Detalle del Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetalleBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear/Editar Producto -->
<div class="modal fade" id="modalProducto" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content modern-modal">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="modalProductoTitle">Nuevo Producto</h5>
                    <p class="text-muted small mb-0" id="modalProductoSubtitle">Completa los datos del producto</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="formProducto" action="{% url 'crear_producto' %}">
                    {% csrf_token %}
                    <input type="hidden" id="productoId" name="producto_id">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Código del Producto *</label>
                            <input type="number" class="form-control" name="codigo" id="inputCodigo" placeholder="Auto-generado" readonly>
                            <small class="text-muted">El código se genera automáticamente</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Categoría</label>
                            <select class="form-select" name="categoria" id="inputCategoria">
                                <option value="">Seleccionar categoría</option>
                                {% for producto in productos %}
                                    {% if producto.categoria %}
                                        <option value="{{ producto.categoria.id }}">{{ producto.categoria.nombre }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Descripción del Producto *</label>
                            <textarea class="form-control" name="descripcion" id="inputDescripcion" rows="3" placeholder="Descripción detallada del producto" required></textarea>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Proveedor</label>
                            <select class="form-select" name="proveedor" id="inputProveedor">
                                <option value="">Seleccionar proveedor</option>
                                {% for producto in productos %}
                                    {% if producto.proveedor %}
                                        <option value="{{ producto.proveedor.id }}">{{ producto.proveedor.razon_social }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Stock Inicial *</label>
                            <input type="number" class="form-control" name="stock" id="inputStock" placeholder="0" min="0" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Stock Mínimo *</label>
                            <input type="number" class="form-control" name="stock_minimo" id="inputStockMinimo" placeholder="5" min="0" value="5" required>
                            <small class="text-muted">Alerta cuando llegue a este nivel</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Precio Costo *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="precio_costo" id="inputPrecioCosto" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Margen de Ganancia (%) *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="inputMargenGanancia" placeholder="30" step="0.01" min="0" max="1000" value="30">
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">Ingresa el margen deseado</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Precio Venta *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="precio_venta" id="inputPrecioVenta" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <small class="text-success" id="margenCalculado">Margen: 0.00%</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Estado</label>
                            <select class="form-select" name="estado" id="inputEstado">
                                <option value="1">Activo</option>
                                <option value="0">Inactivo</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <div class="alert alert-info d-flex align-items-start">
                                <i class="bi bi-info-circle me-2 mt-1"></i>
                                <small>
                                    <strong>Ayuda:</strong> El código se genera automáticamente. 
                                    El precio de venta se calcula según el margen, pero puedes editarlo manualmente. 
                                    El stock mínimo sirve para alertas de bajo inventario.
                                </small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="submit" form="formProducto" class="btn btn-primary-modern btn-modern">
                    <i class="bi bi-check-circle"></i> <span id="btnSubmitText">Guardar Producto</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modern-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="delete-icon mb-3">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <h6>¿Estás seguro de eliminar este producto?</h6>
                <p class="text-muted mb-0" id="productoEliminarNombre"></p>
                <div class="alert alert-warning mt-3 text-start">
                    <small><i class="bi bi-info-circle"></i> Esta acción cambiará el estado del producto a inactivo.</small>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="formEliminar" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Eliminar Producto
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Stats Cards */
.stat-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.3s, box-shadow 0.3s;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.12);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    flex-shrink: 0;
}

.stat-card-purple .stat-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.stat-card-green .stat-icon {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
}

.stat-card-orange .stat-icon {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.stat-card-blue .stat-icon {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 13px;
    color: #6b7280;
    font-weight: 500;
}

/* Table Styles */
.code-badge {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    padding: 4px 12px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 13px;
}

.product-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.product-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
}

.product-name {
    font-weight: 600;
    color: #1f2937;
    font-size: 14px;
}

.price-text {
    color: #6b7280;
    font-size: 14px;
}

.price-text-strong {
    color: #1f2937;
    font-size: 15px;
}

.stock-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
}

.stock-low {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.stock-medium {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
}

.stock-high {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
}

.margin-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    color: #10b981;
    font-weight: 600;
    font-size: 13px;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
}

.status-active {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
}

.status-inactive {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn-action {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 16px;
}

.btn-action-view {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

.btn-action-view:hover {
    background: #3b82f6;
    color: white;
    transform: translateY(-2px);
}

.btn-action-edit {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
}

.btn-action-edit:hover {
    background: #f59e0b;
    color: white;
    transform: translateY(-2px);
}

.btn-action-delete {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.btn-action-delete:hover {
    background: #ef4444;
    color: white;
    transform: translateY(-2px);
}

.empty-state {
    padding: 40px;
}

.empty-state i {
    font-size: 64px;
    color: #d1d5db;
    margin-bottom: 16px;
}

.empty-state p {
    color: #6b7280;
    margin: 0;
}

.product-detail-image {
    width: 120px;
    height: 120px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    color: white;
    margin: 0 auto;
}

.detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.detail-item label {
    font-size: 13px;
    color: #6b7280;
    display: block;
    margin-bottom: 5px;
}

.detail-value {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
}

/* Modal Styles */
.modern-modal .modal-content {
    border: none;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modern-modal .modal-header {
    border-bottom: 1px solid #f3f4f6;
    padding: 24px;
}

.modern-modal .modal-body {
    padding: 24px;
}

.modern-modal .modal-footer {
    border-top: 1px solid #f3f4f6;
    padding: 20px 24px;
}

.delete-icon {
    width: 80px;
    height: 80px;
    background: rgba(239, 68, 68, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    font-size: 36px;
    color: #ef4444;
}

/* Responsive */
@media (max-width: 768px) {
    .stat-card {
        flex-direction: column;
        text-align: center;
    }
    
    .stat-icon {
        width: 48px;
        height: 48px;
        font-size: 24px;
    }
    
    .stat-value {
        font-size: 20px;
    }
    
    .product-actions {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Variables globales
let modoEdicion = false;
let productoIdActual = null;

// Generar código automático al abrir modal
async function generarCodigoAutomatico() {
    try {
        // Obtener el siguiente código desde el servidor
        const response = await fetch('/inventario/productos/siguiente-codigo/');
        const data = await response.json();
        return data.codigo;
    } catch (error) {
        console.error('Error al obtener código:', error);
        // Fallback: calcular desde la tabla
        const filas = document.querySelectorAll('#tablaProductos tbody tr[data-producto-id]');
        let maxCodigo = 999;
        
        filas.forEach(fila => {
            const codigoBadge = fila.querySelector('.code-badge');
            if (codigoBadge) {
                const codigo = parseInt(codigoBadge.textContent.replace('#', ''));
                if (codigo > maxCodigo) {
                    maxCodigo = codigo;
                }
            }
        });
        
        return maxCodigo + 1;
    }
}

// Abrir modal para nuevo producto
async function abrirModalNuevo() {
    modoEdicion = false;
    productoIdActual = null;
    
    document.getElementById('modalProductoTitle').textContent = 'Nuevo Producto';
    document.getElementById('modalProductoSubtitle').textContent = 'Completa los datos del producto';
    document.getElementById('btnSubmitText').textContent = 'Guardar Producto';
    document.getElementById('formProducto').action = "{% url 'crear_producto' %}";
    
    // Limpiar formulario
    document.getElementById('formProducto').reset();
    document.getElementById('productoId').value = '';
    document.getElementById('inputStockMinimo').value = '5';
    document.getElementById('inputMargenGanancia').value = '30';
    
    // Generar código automático
    const nuevoCodigo = await generarCodigoAutomatico();
    document.getElementById('inputCodigo').value = nuevoCodigo;
    
    // Resetear cálculos
    document.getElementById('margenCalculado').textContent = 'Margen: 0.00%';
}

// Abrir modal para editar producto
function abrirModalEditar(id, codigo, descripcion, precioCosto, precioVenta, stock, categoriaId, proveedorId, estado, stockMinimo = 5) {
    modoEdicion = true;
    productoIdActual = id;
    
    document.getElementById('modalProductoTitle').textContent = 'Editar Producto';
    document.getElementById('modalProductoSubtitle').textContent = 'Actualiza los datos del producto';
    document.getElementById('btnSubmitText').textContent = 'Guardar Cambios';
    document.getElementById('formProducto').action = `/inventario/productos/editar/${id}/`;
    
    // Llenar formulario
    document.getElementById('productoId').value = id;
    document.getElementById('inputCodigo').value = codigo;
    document.getElementById('inputDescripcion').value = descripcion;
    document.getElementById('inputPrecioCosto').value = precioCosto;
    document.getElementById('inputPrecioVenta').value = precioVenta;
    document.getElementById('inputStock').value = stock;
    document.getElementById('inputStockMinimo').value = stockMinimo;
    document.getElementById('inputCategoria').value = categoriaId;
    document.getElementById('inputProveedor').value = proveedorId;
    document.getElementById('inputEstado').value = estado;
    
    // Calcular margen actual
    calcularMargenActual();
}

// Calcular precio de venta según margen
function calcularPrecioVenta() {
    const precioCosto = parseFloat(document.getElementById('inputPrecioCosto').value) || 0;
    const margen = parseFloat(document.getElementById('inputMargenGanancia').value) || 0;
    
    if (precioCosto > 0 && margen >= 0) {
        const precioVenta = precioCosto * (1 + margen / 100);
        document.getElementById('inputPrecioVenta').value = precioVenta.toFixed(2);
        document.getElementById('margenCalculado').textContent = `Margen: ${margen.toFixed(2)}%`;
    }
}

// Calcular margen según precio de venta
function calcularMargenActual() {
    const precioCosto = parseFloat(document.getElementById('inputPrecioCosto').value) || 0;
    const precioVenta = parseFloat(document.getElementById('inputPrecioVenta').value) || 0;
    
    if (precioCosto > 0 && precioVenta > 0) {
        const margen = ((precioVenta - precioCosto) / precioCosto) * 100;
        document.getElementById('inputMargenGanancia').value = margen.toFixed(2);
        document.getElementById('margenCalculado').textContent = `Margen: ${margen.toFixed(2)}%`;
        
        // Cambiar color según el margen
        const margenEl = document.getElementById('margenCalculado');
        if (margen < 0) {
            margenEl.className = 'text-danger';
        } else if (margen < 15) {
            margenEl.className = 'text-warning';
        } else {
            margenEl.className = 'text-success';
        }
    }
}

// Event listeners para cálculos automáticos
document.addEventListener('DOMContentLoaded', function() {
    // Calcular precio de venta cuando cambia el costo o margen
    const precioCostoInput = document.getElementById('inputPrecioCosto');
    const margenInput = document.getElementById('inputMargenGanancia');
    const precioVentaInput = document.getElementById('inputPrecioVenta');
    
    if (precioCostoInput && margenInput) {
        precioCostoInput.addEventListener('input', calcularPrecioVenta);
        margenInput.addEventListener('input', calcularPrecioVenta);
    }
    
    // Recalcular margen cuando el usuario edita el precio de venta manualmente
    if (precioVentaInput) {
        precioVentaInput.addEventListener('input', calcularMargenActual);
    }
});

// Confirmar eliminación
function confirmarEliminar(id, nombre) {
    document.getElementById('productoEliminarNombre').textContent = nombre;
    document.getElementById('formEliminar').action = `/inventario/productos/eliminar/${id}/`;
    const modal = new bootstrap.Modal(document.getElementById('modalEliminar'));
    modal.show();
}

// Búsqueda y filtrado
document.getElementById('searchInput').addEventListener('keyup', filtrarProductos);
document.getElementById('filterCategoria').addEventListener('change', filtrarProductos);
document.getElementById('filterStock').addEventListener('change', filtrarProductos);

function filtrarProductos() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const categoria = document.getElementById('filterCategoria').value.toLowerCase();
    const stockFilter = document.getElementById('filterStock').value;
    
    const productos = document.querySelectorAll('.producto-row');
    
    productos.forEach(producto => {
        const codigo = producto.dataset.codigo.toLowerCase();
        const descripcion = producto.dataset.descripcion.toLowerCase();
        const prodCategoria = producto.dataset.categoria.toLowerCase();
        const stock = parseInt(producto.dataset.stock);
        
        let mostrar = true;
        
        // Filtro de búsqueda
        if (searchText && !codigo.includes(searchText) && !descripcion.includes(searchText)) {
            mostrar = false;
        }
        
        // Filtro de categoría
        if (categoria && !prodCategoria.includes(categoria)) {
            mostrar = false;
        }
        
        // Filtro de stock
        if (stockFilter) {
            if (stockFilter === 'bajo' && stock >= 10) mostrar = false;
            if (stockFilter === 'medio' && (stock < 10 || stock > 50)) mostrar = false;
            if (stockFilter === 'alto' && stock <= 50) mostrar = false;
        }
        
        producto.style.display = mostrar ? '' : 'none';
    });
}

// Ver detalle del producto
function verDetalleProducto(id, codigo, descripcion, precioCosto, precioVenta, stock, categoria, proveedor, margen) {
    const modalBody = document.getElementById('modalDetalleBody');
    
    modalBody.innerHTML = `
        <div class="row g-4">
            <div class="col-md-4 text-center">
                <div class="product-detail-image">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="mt-3">
                    <span class="status-badge status-active">Activo</span>
                </div>
            </div>
            <div class="col-md-8">
                <h4>${descripcion}</h4>
                <p class="text-muted">Código: <span class="code-badge">#${codigo}</span></p>
                
                <div class="detail-grid mt-4">
                    <div class="detail-item">
                        <label>Precio Costo</label>
                        <div class="detail-value">${precioCosto}</div>
                    </div>
                    <div class="detail-item">
                        <label>Precio Venta</label>
                        <div class="detail-value text-success">${precioVenta}</div>
                    </div>
                    <div class="detail-item">
                        <label>Stock Disponible</label>
                        <div class="detail-value">${stock} unidades</div>
                    </div>
                    <div class="detail-item">
                        <label>Margen de Ganancia</label>
                        <div class="detail-value text-success">${margen}%</div>
                    </div>
                    <div class="detail-item">
                        <label>Categoría</label>
                        <div class="detail-value">${categoria}</div>
                    </div>
                    <div class="detail-item">
                        <label>Proveedor</label>
                        <div class="detail-value">${proveedor}</div>
                    </div>
                </div>
                
                <div class="mt-4 d-flex gap-2">
                    <button class="btn btn-primary-modern btn-modern" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#modalProducto" onclick="abrirModalEditarDesdeDetalle(${id}, '${codigo}', '${descripcion.replace(/'/g, "\\'")}', ${precioCosto}, ${precioVenta}, ${stock})">
                        <i class="bi bi-pencil"></i>
                        Editar Producto
                    </button>
                    <button class="btn btn-modern" style="background: #f3f4f6; color: #374151;" onclick="imprimirEtiqueta(${id})">
                        <i class="bi bi-printer"></i>
                        Imprimir Etiqueta
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
    modal.show();
}

function abrirModalEditarDesdeDetalle(id, codigo, descripcion, precioCosto, precioVenta, stock) {
    // Cerrar modal de detalle primero
    const modalDetalle = bootstrap.Modal.getInstance(document.getElementById('modalDetalle'));
    if (modalDetalle) {
        modalDetalle.hide();
    }
    
    // Pequeño delay para evitar conflictos entre modales
    setTimeout(() => {
        abrirModalEditar(id, codigo, descripcion, precioCosto, precioVenta, stock, '', '', 1);
    }, 300);
}

function imprimirEtiqueta(id) {
    alert('Función de impresión de etiqueta en desarrollo');
}

// Inicializar tooltips
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Auto-cerrar alertas
setTimeout(() => {
    const alerts = document.querySelectorAll('.alert-dismissible');
    alerts.forEach(alert => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    });
}, 5000);
</script>
{% endblock %}{% extends 'base.html' %}

{% block title %}Productos - MotoShop{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Gestión de Productos</h1>
            <p class="page-subtitle">Administra el inventario de repuestos</p>
        </div>
        <button class="btn btn-primary-modern btn-modern" data-bs-toggle="modal" data-bs-target="#modalProducto" onclick="abrirModalNuevo()">
            <i class="bi bi-plus-circle"></i>
            Nuevo Producto
        </button>
    </div>
</div>

<!-- Stats Summary -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="stat-card stat-card-purple">
            <div class="stat-icon">
                <i class="bi bi-box-seam"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ productos|length }}</div>
                <div class="stat-label">Total Productos</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card stat-card-green">
            <div class="stat-icon">
                <i class="bi bi-cash-coin"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">$152,350</div>
                <div class="stat-label">Valor Total del Stock</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card stat-card-orange">
            <div class="stat-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">4</div>
                <div class="stat-label">Productos con Stock Bajo</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card stat-card-blue">
            <div class="stat-icon">
                <i class="bi bi-tags"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">12</div>
                <div class="stat-label">Categorías</div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label small text-muted mb-1">Buscar Producto</label>
                <div class="search-box-modern">
                    <i class="bi bi-search"></i>
                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar por código o descripción...">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Categoría</label>
                <select class="form-select" id="filterCategoria">
                    <option value="">Todas las categorías</option>
                    {% for producto in productos %}
                        {% if producto.categoria %}
                            <option value="{{ producto.categoria.nombre }}">{{ producto.categoria.nombre }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Stock</label>
                <select class="form-select" id="filterStock">
                    <option value="">Todo el stock</option>
                    <option value="bajo">Stock bajo (< 10)</option>
                    <option value="medio">Stock medio (10-50)</option>
                    <option value="alto">Stock alto (> 50)</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-modern w-100" style="background: #f3f4f6; color: #374151;">
                    <i class="bi bi-arrow-clockwise"></i>
                    Limpiar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Products Table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="modern-table" id="tablaProductos">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" class="form-check-input">
                        </th>
                        <th>CÓDIGO</th>
                        <th>PRODUCTO</th>
                        <th>CATEGORÍA</th>
                        <th>PROVEEDOR</th>
                        <th>PRECIO COSTO</th>
                        <th>PRECIO VENTA</th>
                        <th>STOCK</th>
                        <th>MARGEN</th>
                        <th>ESTADO</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr class="producto-row" 
                        data-codigo="{{ producto.codigo }}"
                        data-descripcion="{{ producto.descripcion }}"
                        data-categoria="{{ producto.categoria.nombre|default:'' }}"
                        data-stock="{{ producto.stock }}">
                        <td>
                            <input type="checkbox" class="form-check-input">
                        </td>
                        <td>
                            <span class="code-badge">#{{ producto.codigo }}</span>
                        </td>
                        <td>
                            <div class="product-info">
                                <div class="product-avatar">
                                    <i class="bi bi-box-seam"></i>
                                </div>
                                <div>
                                    <div class="product-name">{{ producto.descripcion|truncatewords:10 }}</div>
                                    <small class="text-muted">SKU: {{ producto.codigo }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if producto.categoria %}
                                <span class="badge-modern" style="background: rgba(102, 126, 234, 0.1); color: #667eea;">
                                    {{ producto.categoria.nombre }}
                                </span>
                            {% else %}
                                <span class="badge-modern" style="background: #f3f4f6; color: #6b7280;">
                                    Sin categoría
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if producto.proveedor %}
                                <small>{{ producto.proveedor.razon_social|truncatewords:3 }}</small>
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="price-text">${{ producto.precio_costo }}</span>
                        </td>
                        <td>
                            <strong class="price-text-strong">${{ producto.precio_venta }}</strong>
                        </td>
                        <td>
                            {% if producto.stock <= producto.stock_minimo %}
                                <span class="stock-badge stock-low">
                                    <i class="bi bi-exclamation-circle"></i>
                                    {{ producto.stock }}
                                </span>
                            {% elif producto.stock <= producto.stock_minimo|add:"15" %}
                                <span class="stock-badge stock-medium">
                                    <i class="bi bi-dash-circle"></i>
                                    {{ producto.stock }}
                                </span>
                            {% else %}
                                <span class="stock-badge stock-high">
                                    <i class="bi bi-check-circle"></i>
                                    {{ producto.stock }}
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="margin-badge">
                                <i class="bi bi-graph-up-arrow"></i>
                                {{ producto.margen_ganancia|floatformat:1 }}%
                            </span>
                        </td>
                        <td>
                            {% if producto.estado == 1 %}
                                <span class="status-badge status-active">Activo</span>
                            {% else %}
                                <span class="status-badge status-inactive">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-action-view" data-bs-toggle="tooltip" title="Ver detalles" onclick="verDetalleProducto({{ producto.id }}, '{{ producto.codigo }}', '{{ producto.descripcion|escapejs }}', {{ producto.precio_costo }}, {{ producto.precio_venta }}, {{ producto.stock }}, '{{ producto.categoria.nombre|default:"Sin categoría" }}', '{{ producto.proveedor.razon_social|default:"Sin proveedor" }}', {{ producto.margen_ganancia|floatformat:1 }})">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn-action btn-action-edit" data-bs-toggle="modal" data-bs-target="#modalProducto" onclick="abrirModalEditar({{ producto.id }}, '{{ producto.codigo }}', '{{ producto.descripcion|escapejs }}', {{ producto.precio_costo }}, {{ producto.precio_venta }}, {{ producto.stock }}, '{{ producto.categoria.id|default:'' }}', '{{ producto.proveedor.id|default:'' }}', {{ producto.estado }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn-action btn-action-delete" onclick="confirmarEliminar({{ producto.id }}, '{{ producto.descripcion|escapejs }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="11" class="text-center py-5">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>No hay productos registrados</p>
                                <button class="btn btn-primary-modern btn-modern mt-3" data-bs-toggle="modal" data-bs-target="#modalProducto" onclick="abrirModalNuevo()">
                                    <i class="bi bi-plus-circle"></i>
                                    Crear Primer Producto
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Detalle Producto -->
<div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content modern-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title">Detalle del Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetalleBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear/Editar Producto -->
<div class="modal fade" id="modalProducto" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content modern-modal">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="modalProductoTitle">Nuevo Producto</h5>
                    <p class="text-muted small mb-0" id="modalProductoSubtitle">Completa los datos del producto</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="formProducto" action="{% url 'crear_producto' %}">
                    {% csrf_token %}
                    <input type="hidden" id="productoId" name="producto_id">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Código del Producto *</label>
                            <input type="number" class="form-control" name="codigo" id="inputCodigo" placeholder="Auto-generado" readonly>
                            <small class="text-muted">El código se genera automáticamente</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Categoría</label>
                            <select class="form-select" name="categoria" id="inputCategoria">
                                <option value="">Seleccionar categoría</option>
                                {% for producto in productos %}
                                    {% if producto.categoria %}
                                        <option value="{{ producto.categoria.id }}">{{ producto.categoria.nombre }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Descripción del Producto *</label>
                            <textarea class="form-control" name="descripcion" id="inputDescripcion" rows="3" placeholder="Descripción detallada del producto" required></textarea>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Proveedor</label>
                            <select class="form-select" name="proveedor" id="inputProveedor">
                                <option value="">Seleccionar proveedor</option>
                                {% for producto in productos %}
                                    {% if producto.proveedor %}
                                        <option value="{{ producto.proveedor.id }}">{{ producto.proveedor.razon_social }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Stock Inicial *</label>
                            <input type="number" class="form-control" name="stock" id="inputStock" placeholder="0" min="0" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Stock Mínimo *</label>
                            <input type="number" class="form-control" name="stock_minimo" id="inputStockMinimo" placeholder="5" min="0" value="5" required>
                            <small class="text-muted">Alerta cuando llegue a este nivel</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Precio Costo *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="precio_costo" id="inputPrecioCosto" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Margen de Ganancia (%) *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="inputMargenGanancia" placeholder="30" step="0.01" min="0" max="1000" value="30">
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">Ingresa el margen deseado</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Precio Venta *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="precio_venta" id="inputPrecioVenta" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <small class="text-success" id="margenCalculado">Margen: 0.00%</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Estado</label>
                            <select class="form-select" name="estado" id="inputEstado">
                                <option value="1">Activo</option>
                                <option value="0">Inactivo</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <div class="alert alert-info d-flex align-items-start">
                                <i class="bi bi-info-circle me-2 mt-1"></i>
                                <small>
                                    <strong>Ayuda:</strong> El código se genera automáticamente. 
                                    El precio de venta se calcula según el margen, pero puedes editarlo manualmente. 
                                    El stock mínimo sirve para alertas de bajo inventario.
                                </small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="submit" form="formProducto" class="btn btn-primary-modern btn-modern">
                    <i class="bi bi-check-circle"></i> <span id="btnSubmitText">Guardar Producto</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modern-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="delete-icon mb-3">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <h6>¿Estás seguro de eliminar este producto?</h6>
                <p class="text-muted mb-0" id="productoEliminarNombre"></p>
                <div class="alert alert-warning mt-3 text-start">
                    <small><i class="bi bi-info-circle"></i> Esta acción cambiará el estado del producto a inactivo.</small>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="formEliminar" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Eliminar Producto
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Stats Cards */
.stat-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.3s, box-shadow 0.3s;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.12);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    flex-shrink: 0;
}

.stat-card-purple .stat-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.stat-card-green .stat-icon {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
}

.stat-card-orange .stat-icon {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.stat-card-blue .stat-icon {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 13px;
    color: #6b7280;
    font-weight: 500;
}

/* Table Styles */
.code-badge {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    padding: 4px 12px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 13px;
}

.product-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.product-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
}

.product-name {
    font-weight: 600;
    color: #1f2937;
    font-size: 14px;
}

.price-text {
    color: #6b7280;
    font-size: 14px;
}

.price-text-strong {
    color: #1f2937;
    font-size: 15px;
}

.stock-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
}

.stock-low {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.stock-medium {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
}

.stock-high {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
}

.margin-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    color: #10b981;
    font-weight: 600;
    font-size: 13px;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
}

.status-active {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
}

.status-inactive {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn-action {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 16px;
}

.btn-action-view {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

.btn-action-view:hover {
    background: #3b82f6;
    color: white;
    transform: translateY(-2px);
}

.btn-action-edit {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
}

.btn-action-edit:hover {
    background: #f59e0b;
    color: white;
    transform: translateY(-2px);
}

.btn-action-delete {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.btn-action-delete:hover {
    background: #ef4444;
    color: white;
    transform: translateY(-2px);
}

.empty-state {
    padding: 40px;
}

.empty-state i {
    font-size: 64px;
    color: #d1d5db;
    margin-bottom: 16px;
}

.empty-state p {
    color: #6b7280;
    margin: 0;
}

.product-detail-image {
    width: 120px;
    height: 120px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    color: white;
    margin: 0 auto;
}

.detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.detail-item label {
    font-size: 13px;
    color: #6b7280;
    display: block;
    margin-bottom: 5px;
}

.detail-value {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
}

/* Modal Styles */
.modern-modal .modal-content {
    border: none;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modern-modal .modal-header {
    border-bottom: 1px solid #f3f4f6;
    padding: 24px;
}

.modern-modal .modal-body {
    padding: 24px;
}

.modern-modal .modal-footer {
    border-top: 1px solid #f3f4f6;
    padding: 20px 24px;
}

.delete-icon {
    width: 80px;
    height: 80px;
    background: rgba(239, 68, 68, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    font-size: 36px;
    color: #ef4444;
}

/* Responsive */
@media (max-width: 768px) {
    .stat-card {
        flex-direction: column;
        text-align: center;
    }
    
    .stat-icon {
        width: 48px;
        height: 48px;
        font-size: 24px;
    }
    
    .stat-value {
        font-size: 20px;
    }
    
    .product-actions {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Variables globales
let modoEdicion = false;
let productoIdActual = null;

// Generar código automático al abrir modal
async function generarCodigoAutomatico() {
    try {
        // Obtener el siguiente código desde el servidor
        const response = await fetch('/inventario/productos/siguiente-codigo/');
        const data = await response.json();
        return data.codigo;
    } catch (error) {
        console.error('Error al obtener código:', error);
        // Fallback: calcular desde la tabla
        const filas = document.querySelectorAll('#tablaProductos tbody tr[data-producto-id]');
        let maxCodigo = 999;
        
        filas.forEach(fila => {
            const codigoBadge = fila.querySelector('.code-badge');
            if (codigoBadge) {
                const codigo = parseInt(codigoBadge.textContent.replace('#', ''));
                if (codigo > maxCodigo) {
                    maxCodigo = codigo;
                }
            }
        });
        
        return maxCodigo + 1;
    }
}

// Abrir modal para nuevo producto
async function abrirModalNuevo() {
    modoEdicion = false;
    productoIdActual = null;
    
    document.getElementById('modalProductoTitle').textContent = 'Nuevo Producto';
    document.getElementById('modalProductoSubtitle').textContent = 'Completa los datos del producto';
    document.getElementById('btnSubmitText').textContent = 'Guardar Producto';
    document.getElementById('formProducto').action = "{% url 'crear_producto' %}";
    
    // Limpiar formulario
    document.getElementById('formProducto').reset();
    document.getElementById('productoId').value = '';
    document.getElementById('inputStockMinimo').value = '5';
    document.getElementById('inputMargenGanancia').value = '30';
    
    // Generar código automático
    const nuevoCodigo = await generarCodigoAutomatico();
    document.getElementById('inputCodigo').value = nuevoCodigo;
    
    // Resetear cálculos
    document.getElementById('margenCalculado').textContent = 'Margen: 0.00%';
}

// Abrir modal para editar producto
function abrirModalEditar(id, codigo, descripcion, precioCosto, precioVenta, stock, categoriaId, proveedorId, estado, stockMinimo = 5) {
    modoEdicion = true;
    productoIdActual = id;
    
    document.getElementById('modalProductoTitle').textContent = 'Editar Producto';
    document.getElementById('modalProductoSubtitle').textContent = 'Actualiza los datos del producto';
    document.getElementById('btnSubmitText').textContent = 'Guardar Cambios';
    document.getElementById('formProducto').action = `/inventario/productos/editar/${id}/`;
    
    // Llenar formulario
    document.getElementById('productoId').value = id;
    document.getElementById('inputCodigo').value = codigo;
    document.getElementById('inputDescripcion').value = descripcion;
    document.getElementById('inputPrecioCosto').value = precioCosto;
    document.getElementById('inputPrecioVenta').value = precioVenta;
    document.getElementById('inputStock').value = stock;
    document.getElementById('inputStockMinimo').value = stockMinimo;
    document.getElementById('inputCategoria').value = categoriaId;
    document.getElementById('inputProveedor').value = proveedorId;
    document.getElementById('inputEstado').value = estado;
    
    // Calcular margen actual
    calcularMargenActual();
}

// Calcular precio de venta según margen
function calcularPrecioVenta() {
    const precioCosto = parseFloat(document.getElementById('inputPrecioCosto').value) || 0;
    const margen = parseFloat(document.getElementById('inputMargenGanancia').value) || 0;
    
    if (precioCosto > 0 && margen >= 0) {
        const precioVenta = precioCosto * (1 + margen / 100);
        document.getElementById('inputPrecioVenta').value = precioVenta.toFixed(2);
        document.getElementById('margenCalculado').textContent = `Margen: ${margen.toFixed(2)}%`;
    }
}

// Calcular margen según precio de venta
function calcularMargenActual() {
    const precioCosto = parseFloat(document.getElementById('inputPrecioCosto').value) || 0;
    const precioVenta = parseFloat(document.getElementById('inputPrecioVenta').value) || 0;
    
    if (precioCosto > 0 && precioVenta > 0) {
        const margen = ((precioVenta - precioCosto) / precioCosto) * 100;
        document.getElementById('inputMargenGanancia').value = margen.toFixed(2);
        document.getElementById('margenCalculado').textContent = `Margen: ${margen.toFixed(2)}%`;
        
        // Cambiar color según el margen
        const margenEl = document.getElementById('margenCalculado');
        if (margen < 0) {
            margenEl.className = 'text-danger';
        } else if (margen < 15) {
            margenEl.className = 'text-warning';
        } else {
            margenEl.className = 'text-success';
        }
    }
}

// Event listeners para cálculos automáticos
document.addEventListener('DOMContentLoaded', function() {
    // Calcular precio de venta cuando cambia el costo o margen
    const precioCostoInput = document.getElementById('inputPrecioCosto');
    const margenInput = document.getElementById('inputMargenGanancia');
    const precioVentaInput = document.getElementById('inputPrecioVenta');
    
    if (precioCostoInput && margenInput) {
        precioCostoInput.addEventListener('input', calcularPrecioVenta);
        margenInput.addEventListener('input', calcularPrecioVenta);
    }
    
    // Recalcular margen cuando el usuario edita el precio de venta manualmente
    if (precioVentaInput) {
        precioVentaInput.addEventListener('input', calcularMargenActual);
    }
});

// Confirmar eliminación
function confirmarEliminar(id, nombre) {
    document.getElementById('productoEliminarNombre').textContent = nombre;
    document.getElementById('formEliminar').action = `/inventario/productos/eliminar/${id}/`;
    const modal = new bootstrap.Modal(document.getElementById('modalEliminar'));
    modal.show();
}

// Búsqueda y filtrado
document.getElementById('searchInput').addEventListener('keyup', filtrarProductos);
document.getElementById('filterCategoria').addEventListener('change', filtrarProductos);
document.getElementById('filterStock').addEventListener('change', filtrarProductos);

function filtrarProductos() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const categoria = document.getElementById('filterCategoria').value.toLowerCase();
    const stockFilter = document.getElementById('filterStock').value;
    
    const productos = document.querySelectorAll('.producto-row');
    
    productos.forEach(producto => {
        const codigo = producto.dataset.codigo.toLowerCase();
        const descripcion = producto.dataset.descripcion.toLowerCase();
        const prodCategoria = producto.dataset.categoria.toLowerCase();
        const stock = parseInt(producto.dataset.stock);
        
        let mostrar = true;
        
        // Filtro de búsqueda
        if (searchText && !codigo.includes(searchText) && !descripcion.includes(searchText)) {
            mostrar = false;
        }
        
        // Filtro de categoría
        if (categoria && !prodCategoria.includes(categoria)) {
            mostrar = false;
        }
        
        // Filtro de stock
        if (stockFilter) {
            if (stockFilter === 'bajo' && stock >= 10) mostrar = false;
            if (stockFilter === 'medio' && (stock < 10 || stock > 50)) mostrar = false;
            if (stockFilter === 'alto' && stock <= 50) mostrar = false;
        }
        
        producto.style.display = mostrar ? '' : 'none';
    });
}

// Ver detalle del producto
function verDetalleProducto(id, codigo, descripcion, precioCosto, precioVenta, stock, categoria, proveedor, margen) {
    const modalBody = document.getElementById('modalDetalleBody');
    
    modalBody.innerHTML = `
        <div class="row g-4">
            <div class="col-md-4 text-center">
                <div class="product-detail-image">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="mt-3">
                    <span class="status-badge status-active">Activo</span>
                </div>
            </div>
            <div class="col-md-8">
                <h4>${descripcion}</h4>
                <p class="text-muted">Código: <span class="code-badge">#${codigo}</span></p>
                
                <div class="detail-grid mt-4">
                    <div class="detail-item">
                        <label>Precio Costo</label>
                        <div class="detail-value">${precioCosto}</div>
                    </div>
                    <div class="detail-item">
                        <label>Precio Venta</label>
                        <div class="detail-value text-success">${precioVenta}</div>
                    </div>
                    <div class="detail-item">
                        <label>Stock Disponible</label>
                        <div class="detail-value">${stock} unidades</div>
                    </div>
                    <div class="detail-item">
                        <label>Margen de Ganancia</label>
                        <div class="detail-value text-success">${margen}%</div>
                    </div>
                    <div class="detail-item">
                        <label>Categoría</label>
                        <div class="detail-value">${categoria}</div>
                    </div>
                    <div class="detail-item">
                        <label>Proveedor</label>
                        <div class="detail-value">${proveedor}</div>
                    </div>
                </div>
                
                <div class="mt-4 d-flex gap-2">
                    <button class="btn btn-primary-modern btn-modern" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#modalProducto" onclick="abrirModalEditarDesdeDetalle(${id}, '${codigo}', '${descripcion.replace(/'/g, "\\'")}', ${precioCosto}, ${precioVenta}, ${stock})">
                        <i class="bi bi-pencil"></i>
                        Editar Producto
                    </button>
                    <button class="btn btn-modern" style="background: #f3f4f6; color: #374151;" onclick="imprimirEtiqueta(${id})">
                        <i class="bi bi-printer"></i>
                        Imprimir Etiqueta
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
    modal.show();
}

function abrirModalEditarDesdeDetalle(id, codigo, descripcion, precioCosto, precioVenta, stock) {
    // Cerrar modal de detalle primero
    const modalDetalle = bootstrap.Modal.getInstance(document.getElementById('modalDetalle'));
    if (modalDetalle) {
        modalDetalle.hide();
    }
    
    // Pequeño delay para evitar conflictos entre modales
    setTimeout(() => {
        abrirModalEditar(id, codigo, descripcion, precioCosto, precioVenta, stock, '', '', 1);
    }, 300);
}

function imprimirEtiqueta(id) {
    alert('Función de impresión de etiqueta en desarrollo');
}

// Inicializar tooltips
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Auto-cerrar alertas
setTimeout(() => {
    const alerts = document.querySelectorAll('.alert-dismissible');
    alerts.forEach(alert => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    });
}, 5000);
</script>
{% endblock %}